# API æ¥å£æ–‡æ¡£

æœ¬æ–‡æ¡£åŒ…å«äº† Analytics Hub backend æ‰€æœ‰å¯ç”¨çš„ API æ¥å£ä¿¡æ¯ï¼Œåˆ†ä¸º **å®¢æˆ·ç«¯é‡‡é›† API**ã€**ç³»ç»Ÿç®¡ç† API** å’Œ **å¥åº·æ£€æŸ¥** ä¸‰å¤§ç±»ã€‚

---

## ğŸ” è®¤è¯æœºåˆ¶

### 1. å®¢æˆ·ç«¯é‡‡é›†è®¤è¯ (HMAC ç­¾å)
é€‚ç”¨äºç§»åŠ¨ç«¯ã€Webç«¯ã€IoTè®¾å¤‡ã€‚ä¸ºäº†é˜²æ­¢æ•°æ®ä¼ªé€ ï¼Œé™¤æ³¨å†Œæ¥å£å¤–ï¼Œæ‰€æœ‰é‡‡é›†æ¥å£å¿…é¡»è¿›è¡Œ HMAC ç­¾åã€‚

**å¿…éœ€ Header**:
| Header | è¯´æ˜ | ç¤ºä¾‹ |
|--------|------|------|
| `X-Project-ID` | é¡¹ç›®æ ‡è¯†ç¬¦ | `memobox` |
| `X-API-Key` | æ³¨å†Œæ—¶è·å¾—çš„å…¬å¼€ Key | `api_live_xxxx` |
| `X-Device-ID` | è®¾å¤‡å”¯ä¸€ç¡¬ä»¶ ID (UUID) | `550e8400-e29b...` |
| `X-Timestamp` | å½“å‰æ¯«ç§’æ—¶é—´æˆ³ | `1704856000000` |
| `X-Signature` | HMAC-SHA256 ç­¾åç»“æœ | `Base64(...)` |

**ç­¾åç®—æ³•**:
1. æ‹¼æ¥å­—ç¬¦ä¸²: `method + "\n" + path + "\n" + timestamp + "\n" + deviceId + "\n" + userId + "\n" + body`
2. ä½¿ç”¨ `secretKey` (æ³¨å†Œè·å¾—) å¯¹ä¸Šè¿°å­—ç¬¦ä¸²è¿›è¡Œ HMAC-SHA256 åŠ å¯†ã€‚
3. å¯¹åŠ å¯†ç»“æœè¿›è¡Œ **Base64** ç¼–ç ã€‚

### 2. ç³»ç»Ÿç®¡ç†è®¤è¯ (Bearer Token)
é€‚ç”¨äº CMS ç®¡ç†åå°æˆ–å†…éƒ¨è„šæœ¬ã€‚

**å¿…éœ€ Header**:
```http
Authorization: Bearer <ADMIN_TOKEN>
```
*æ³¨ï¼šADMIN_TOKEN åœ¨åç«¯ `.env` æ–‡ä»¶ä¸­é…ç½®ã€‚*

---

## ğŸ“± å®¢æˆ·ç«¯é‡‡é›† API (v1)

### 1. è®¾å¤‡æ³¨å†Œ
**é¦–æ¬¡å¯åŠ¨æ—¶è°ƒç”¨**ï¼Œè·å–é€šä¿¡æ‰€éœ€çš„ API Key å’Œ Secret Keyã€‚

- **URL**: `POST /api/v1/auth/register`
- **è®¤è¯**: æ— éœ€ç­¾åï¼Œä½†éœ€æºå¸¦ `X-Project-ID` Headerã€‚
- **è¯·æ±‚ä½“**:
```json
{
  "device_id": "UUID",
  "device_model": "iPhone 15 Pro",
  "os_version": "iOS 17.0",
  "app_version": "1.0.0"
}
```
- **å“åº”**: `api_key` å’Œ `secret_key`ã€‚

### 2. å•äº‹ä»¶ä¸ŠæŠ¥
ä¸ŠæŠ¥å…·ä½“çš„è¡Œä¸ºï¼ˆå¦‚æŒ‰é’®ç‚¹å‡»ã€é¡µé¢è®¿é—®ï¼‰ã€‚

- **URL**: `POST /api/v1/events/track`
- **è®¤è¯**: HMAC ç­¾å
- **è¯·æ±‚ä½“**:
```json
{
  "event_type": "button_click",
  "timestamp": 1704856000000, 
  "session_id": "å¯é€‰ UUID",
  "properties": { "button_name": "login", "color": "blue" }
}
```

### 3. æ‰¹é‡äº‹ä»¶ä¸ŠæŠ¥
ç”¨äºç½‘ç»œæ³¢åŠ¨é‡å‘æš‚å­˜äº‹ä»¶ï¼Œæˆ–é™ä½è¯·æ±‚é¢‘ç‡ã€‚

- **URL**: `POST /api/v1/events/batch`
- **è®¤è¯**: HMAC ç­¾å
- **å‚æ•°**: `{"events": [...]}` (æœ€å¤š 100 æ¡)

### 4. ä¼šè¯ (Session) ä¸Šä¼ 
è®°å½•ç”¨æˆ·çš„ä¸€æ¬¡å¯åŠ¨åˆ°é€€å‡ºçš„å®Œæ•´ä¼šè¯ã€‚æ”¯æŒ **Upsert** (å¦‚æœ session_id å·²å­˜åœ¨åˆ™æ›´æ–°æ—¶é•¿å’Œäº‹ä»¶æ•°)ã€‚

- **URL**: `POST /api/v1/sessions`
- **è®¤è¯**: HMAC ç­¾å
- **è¯·æ±‚ä½“**:
```json
{
  "session_id": "UUID",
  "session_start_time": "2024-01-10T10:00:00Z",
  "session_duration_ms": 120000,
  "event_count": 15,
  "screen_count": 5,
  "app_version": "1.0.0"
}
```

### 5. è®¤è¯æµ‹è¯• (Debug)
ç”¨äºéªŒè¯ä½ çš„ HMAC ç­¾åé€»è¾‘æ˜¯å¦æ­£ç¡®ã€‚

- **URL**: `GET /api/v1/protected/test`
- **è®¤è¯**: HMAC ç­¾å

---

## âš™ï¸ ç³»ç»Ÿç®¡ç† API (Admin)

æ‰€æœ‰æ¥å£å‰ç¼€: `/api/admin`
è®¤è¯æ–¹å¼: `Authorization: Bearer <token>`

| è·¯å¾„ | æ–¹æ³• | è¯´æ˜ |
|------|------|------|
| `/projects` | GET | è·å–æ‰€æœ‰é¡¹ç›®é…ç½®åˆ—è¡¨ |
| `/projects` | POST | åˆ›å»ºæ–°é¡¹ç›®é…ç½® |
| `/projects/:id` | PUT | æ›´æ–°é¡¹ç›®ä¿¡æ¯ (åŒ…å«æ¿€æ´»çŠ¶æ€) |
| `/projects/:id` | DELETE | åˆ é™¤é¡¹ç›®é…ç½® |
| `/projects/:id/test` | POST | æµ‹è¯•é¡¹ç›®ç»‘å®šçš„æ•°æ®åº“è¿æ¥ |
| `/projects/:id/init` | POST | æ‰§è¡Œ SQL åˆå§‹åŒ–è¯¥é¡¹ç›®çš„æ•°æ®åº“è¡¨ |
| `/projects/:id/health` | GET | æ£€æŸ¥é¡¹ç›®çš„æ•°æ®åº“è¿é€šæ€§åŠè¡¨å®Œæ•´æ€§ |

---

## ğŸ¥ å¥åº·æ£€æŸ¥ (Health)

- **URL**: `GET /health`
- **è®¤è¯**: æ— 
- **å“åº”ç¤ºä¾‹**:
```json
{
  "success": true,
  "data": {
    "status": "healthy",
    "database": "connected",
    "uptime": 3600
  }
}
```

---

## ğŸ’¡ æ³¨æ„äº‹é¡¹

1. **URL å®Œæ•´æ€§**: æ‰€æœ‰çš„é‡‡é›† API å¿…é¡»åŒ…å« `/api/v1` å‰ç¼€ï¼Œç®¡ç† API å¿…é¡»åŒ…å« `/api/admin` å‰ç¼€ã€‚
2. **404 é”™è¯¯**: å¦‚æœè¿”å› 404ï¼Œè¯·é¦–å…ˆæ£€æŸ¥è¯·æ±‚è·¯å¾„æ˜¯å¦æ¼å†™äº†å­è·¯å¾„ï¼ˆå¦‚ `/events` æ¼å†™äº† `/track`ï¼‰ã€‚
3. **304 å“åº”**: æ˜¯æµè§ˆå™¨/åç«¯ç¼“å­˜æœºåˆ¶äº§ç”Ÿçš„æ­£å¸¸ç°è±¡ï¼Œä¸å½±å“ä¸šåŠ¡ã€‚
4. **æ•°æ®åº“æ¸…ç†**: `traffic_metrics` è¡¨ç›®å‰ç”±ç³»ç»Ÿè‡ªåŠ¨ç»´æŠ¤ï¼Œæ— å…¬å¼€å†™å…¥ APIã€‚
